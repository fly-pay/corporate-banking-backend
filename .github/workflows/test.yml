name: Test

on:
  push:
    branches:
      - '*'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services
        run: |
          docker compose up --build -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to start..."
          sleep 30
          
          # Wait for Oracle database
          echo "Waiting for Oracle database..."
          timeout 120 bash -c 'until docker exec oracle-db lsnrctl status | grep -q "CORPORATE_BANKING"; do sleep 5; done' || true
          
          # Wait for Keycloak
          echo "Waiting for Keycloak..."
          timeout 120 bash -c 'until curl -f http://localhost:8090/health/ready; do sleep 5; done' || true
          
          # Wait for Consul
          echo "Waiting for Consul..."
          timeout 60 bash -c 'until curl -f http://localhost:8500/v1/status/leader; do sleep 5; done' || true
          
          # Wait for application services
          echo "Waiting for application services..."
          timeout 120 bash -c 'until curl -f http://localhost:8080/health && curl -f http://localhost:9005/health && curl -f http://localhost:9002/health; do sleep 5; done' || true

      - name: Check service health
        run: |
          echo "Checking service health endpoints..."
          echo ""
          
          FAILED=0
          
          # Check Gateway Service
          if curl -f http://localhost:8080/health > /dev/null 2>&1; then
            echo "✅ Gateway Service: Healthy"
          else
            echo "❌ Gateway Service: Failed"
            FAILED=1
          fi
          
          # Check Authorization Service
          if curl -f http://localhost:9005/health > /dev/null 2>&1; then
            echo "✅ Authorization Service: Healthy"
          else
            echo "❌ Authorization Service: Failed"
            FAILED=1
          fi
          
          # Check User Service
          if curl -f http://localhost:9002/health > /dev/null 2>&1; then
            echo "✅ User Service: Healthy"
          else
            echo "❌ User Service: Failed"
            FAILED=1
          fi
          
          # Check Oracle Database
          if docker exec oracle-db lsnrctl status | grep -q "CORPORATE_BANKING" > /dev/null 2>&1; then
            echo "✅ Oracle Database: Healthy"
          else
            echo "❌ Oracle Database: Failed"
            FAILED=1
          fi
          
          # Check Keycloak
          if curl -f http://localhost:8090/health/ready > /dev/null 2>&1; then
            echo "✅ Keycloak: Healthy"
          else
            echo "❌ Keycloak: Failed"
            FAILED=1
          fi
          
          # Check Consul
          if curl -f http://localhost:8500/v1/status/leader > /dev/null 2>&1; then
            echo "✅ Consul: Healthy"
          else
            echo "❌ Consul: Failed"
            FAILED=1
          fi
          
          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "❌ Some services failed health checks!"
            exit 1
          else
            echo "✅ All services are healthy!"
          fi

      - name: Check running containers
        run: |
          echo "Checking container status..."
          echo ""
          
          FAILED=0
          
          # Check each service container
          SERVICES=("oracle-db" "consul" "corporate-banking-keycloak" "authorization-service" "gateway-service" "user-service")
          
          for service in "${SERVICES[@]}"; do
            if docker ps --format "{{.Names}}" | grep -q "^${service}$"; then
              STATUS=$(docker inspect --format='{{.State.Status}}' ${service} 2>/dev/null || echo "unknown")
              if [ "$STATUS" = "running" ]; then
                echo "✅ ${service}: Running"
              else
                echo "❌ ${service}: ${STATUS}"
                FAILED=1
              fi
            else
              echo "❌ ${service}: Not found"
              FAILED=1
            fi
          done
          
          echo ""
          echo "Full container status:"
          docker compose ps
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "❌ Some containers are not running properly!"
            exit 1
          else
            echo ""
            echo "✅ All containers are running!"
          fi

      - name: View service logs on failure
        if: failure()
        run: |
          echo "=== Gateway Service Logs ==="
          docker compose logs gateway-service || true
          echo "=== Authorization Service Logs ==="
          docker compose logs authorization-service || true
          echo "=== User Service Logs ==="
          docker compose logs user-service || true
          echo "=== Oracle Database Logs ==="
          docker compose logs oracle-db || true

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
